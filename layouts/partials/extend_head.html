<!-- Typography: Distinctive Editorial Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300..900;1,9..144,300..900&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

<!-- Mermaid.js for diagram rendering -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const isDark = document.body.getAttribute('data-theme') === 'dark' ||
                   (!document.body.getAttribute('data-theme') &&
                    window.matchMedia('(prefers-color-scheme: dark)').matches);

    mermaid.initialize({
      startOnLoad: true,
      theme: isDark ? 'dark' : 'default',
      securityLevel: 'loose',
      flowchart: {
        useMaxWidth: true,
        htmlLabels: true,
        curve: 'basis'
      }
    });
  });
</script>
<style>
  .mermaid {
    text-align: center;
    margin: 1.5rem 0;
    background: transparent;
  }
  .mermaid svg {
    max-width: 100%;
    height: auto;
  }
</style>

<!-- Sticky TOC with Scroll Spy -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  // Only run on single post pages
  const postContent = document.querySelector('.post-content');
  if (!postContent) return;

  // Hide right sidebar on single post pages
  const rightSidebar = document.querySelector('.right-sidebar');
  if (rightSidebar) {
    rightSidebar.style.display = 'none';
  }

  // Get all headings (h2 and h3)
  const headings = postContent.querySelectorAll('h2, h3');
  if (headings.length < 2) return; // Don't show TOC for short articles

  // Create TOC sidebar
  const tocSidebar = document.createElement('div');
  tocSidebar.className = 'toc-sidebar';

  const tocTitle = document.createElement('div');
  tocTitle.className = 'toc-sidebar-title';
  tocTitle.textContent = 'Contents';
  tocSidebar.appendChild(tocTitle);

  const nav = document.createElement('nav');
  const ul = document.createElement('ul');

  let currentH2List = null;

  headings.forEach((heading, index) => {
    // Ensure heading has an ID
    if (!heading.id) {
      heading.id = 'heading-' + index;
    }

    const li = document.createElement('li');
    const a = document.createElement('a');
    a.href = '#' + heading.id;
    a.textContent = heading.textContent;
    a.dataset.target = heading.id;

    if (heading.tagName === 'H2') {
      li.appendChild(a);
      const subUl = document.createElement('ul');
      li.appendChild(subUl);
      ul.appendChild(li);
      currentH2List = subUl;
    } else if (heading.tagName === 'H3' && currentH2List) {
      li.appendChild(a);
      currentH2List.appendChild(li);
    } else {
      li.appendChild(a);
      ul.appendChild(li);
    }
  });

  nav.appendChild(ul);
  tocSidebar.appendChild(nav);
  document.body.appendChild(tocSidebar);

  // Scroll spy functionality
  const tocLinks = tocSidebar.querySelectorAll('a');

  function updateActiveLink() {
    let currentHeading = null;
    const scrollPos = window.scrollY + 120; // Offset for fixed header

    headings.forEach(heading => {
      if (heading.offsetTop <= scrollPos) {
        currentHeading = heading;
      }
    });

    tocLinks.forEach(link => {
      link.classList.remove('active');
      if (currentHeading && link.dataset.target === currentHeading.id) {
        link.classList.add('active');

        // Scroll TOC to keep active item visible
        const tocRect = tocSidebar.getBoundingClientRect();
        const linkRect = link.getBoundingClientRect();
        if (linkRect.top < tocRect.top || linkRect.bottom > tocRect.bottom) {
          link.scrollIntoView({ block: 'center', behavior: 'smooth' });
        }
      }
    });
  }

  // Smooth scroll on TOC link click
  tocLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const targetId = this.getAttribute('href').substring(1);
      const targetElement = document.getElementById(targetId);
      if (targetElement) {
        const offsetTop = targetElement.offsetTop - 100;
        window.scrollTo({
          top: offsetTop,
          behavior: 'smooth'
        });
      }
    });
  });

  // Throttle scroll event
  let ticking = false;
  window.addEventListener('scroll', function() {
    if (!ticking) {
      window.requestAnimationFrame(function() {
        updateActiveLink();
        ticking = false;
      });
      ticking = true;
    }
  });

  // Initial update
  updateActiveLink();
});
</script>
